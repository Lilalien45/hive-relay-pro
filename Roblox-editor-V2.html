<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">

<title>Roblox Web Master Studio Viewer</title>

<script src="https://cdn.jsdelivr.net/npm/three@0.160/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>

<style>

body{
margin:0;
overflow:hidden;
background:#0f1117;
color:white;
font-family:Arial;
touch-action:none;
}

#ui{
position:absolute;
width:100%;
height:100%;
pointer-events:none;
}

.panel{
background:#000a;
padding:10px;
border-radius:8px;
pointer-events:auto;
max-width:90vw;
max-height:80vh;
overflow:auto;
}

#menu{
position:absolute;
top:10px;
left:50%;
transform:translateX(-50%);
}

#explorer{
position:absolute;
left:10px;
top:70px;
width:220px;
height:420px;
overflow:auto;
}

#properties{
position:absolute;
right:10px;
top:70px;
width:260px;
max-height:320px;
overflow:auto;
}

#timeline{
position:absolute;
bottom:10px;
left:50%;
transform:translateX(-50%);
width:min(420px,90vw);
}

#controls{
position:absolute;
bottom:10px;
left:10px;
width:180px;
}

button{
background:#222;
color:white;
border:none;
padding:6px 12px;
margin:4px;
border-radius:6px;
cursor:pointer;
}

@media(max-width:600px){

#explorer{
width:45vw;
height:50vh;
}

#properties{
width:45vw;
height:40vh;
}

button{
padding:10px;
font-size:14px;
}

}

</style>

</head>

<body>

<div id="ui">

<div id="menu" class="panel">
<button onclick="setMode('host')">Host</button>
<button onclick="setMode('private')">Private</button>
<button onclick="setMode('join')">Join</button>
<button onclick="setMode('invite')">Invite Only</button>
<input type="file" id="placeLoader">
</div>

<div id="explorer" class="panel">
<h3>Explorer</h3>
<div id="explorerTree"></div>
</div>

<div id="properties" class="panel">
<h3>Properties</h3>
<div id="propertiesData"></div>
</div>

<div id="timeline" class="panel">
<input type="range" id="timelineSlider" min="0" max="100" value="0">
</div>

<!-- CAMERA CONTROLS + ZOOM -->

<div id="controls" class="panel">

<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;max-width:140px;">

<button style="grid-column:2" onmousedown="moveCam('up')" ontouchstart="moveCam('up')">↑</button>

<button onmousedown="moveCam('left')" ontouchstart="moveCam('left')">←</button>
<button style="visibility:hidden"></button>
<button onmousedown="moveCam('right')" ontouchstart="moveCam('right')">→</button>

<button style="grid-column:2" onmousedown="moveCam('down')" ontouchstart="moveCam('down')">↓</button>

</div>

<br>

<label>Zoom</label>
<input type="range" id="zoomBar" min="100" max="5000" value="1500">

</div>

</div>

<script>

/* ENGINE STATE */

let scene,camera,renderer,xmlDoc=null;
let camTarget=new THREE.Vector3();
let instanceMap=new Map();
let networkMode="private";
let animationTime=0;

/* INIT ENGINE */

function initEngine(){

scene=new THREE.Scene();

let w=window.innerWidth;
let h=window.innerHeight;

camera=new THREE.PerspectiveCamera(
75,w/h,0.1,50000
);

renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(w,h);

document.body.appendChild(renderer.domElement);

scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));
scene.add(new THREE.GridHelper(2000,200));

initControls();
animate();

}

/* CAMERA CONTROLS */

function initControls(){

let rot=false,lx=0,ly=0;

function pointerDown(e){
rot=true;
lx=e.clientX||e.touches?.[0].clientX;
ly=e.clientY||e.touches?.[0].clientY;
}

function pointerMove(e){
if(!rot)return;

let x=e.clientX||e.touches?.[0].clientX;
let y=e.clientY||e.touches?.[0].clientY;

camera.position.x+=(x-lx)*0.05;
camera.position.y-=(y-ly)*0.05;

lx=x;
ly=y;
}

window.addEventListener("pointerdown",pointerDown);
window.addEventListener("touchstart",pointerDown);

window.addEventListener("pointerup",()=>rot=false);
window.addEventListener("touchend",()=>rot=false);

window.addEventListener("pointermove",pointerMove);
window.addEventListener("touchmove",pointerMove,{passive:false});

window.addEventListener("wheel",e=>{
camera.position.z+=e.deltaY*0.5;
});

}

/* CAMERA BUTTON MOVEMENT */

function moveCam(dir){

let speed=40;

switch(dir){

case "up": camera.position.y+=speed; break;
case "down": camera.position.y-=speed; break;
case "left": camera.position.x-=speed; break;
case "right": camera.position.x+=speed; break;

}

}

/* ZOOM BAR */

let zoomBar=document.getElementById("zoomBar");

zoomBar.addEventListener("input",()=>{
camera.position.z=Number(zoomBar.value);
});

/* LOOP */

function animate(){

requestAnimationFrame(animate);

animationTime+=0.01;
updateAnimations();

camera.lookAt(camTarget);
renderer.render(scene,camera);

}

/* SESSION MODE */

function setMode(mode){
networkMode=mode;
alert("Session Mode: "+mode);
}

/* FILE LOAD */

placeLoader.addEventListener("change",e=>{
let f=e.target.files[0];
if(!f)return;

let r=new FileReader();
r.onload=()=>{
parseRobloxXML(r.result);
};
r.readAsText(f);

});

/* PARSER */

function parseRobloxXML(text){

xmlDoc=new DOMParser().parseFromString(text,"text/xml");

buildExplorer();
buildScene();

}

/* EXPLORER */

function buildExplorer(){

let tree=document.getElementById("explorerTree");
tree.innerHTML="";

xmlDoc.documentElement.childNodes.forEach(n=>{
if(n.nodeName==="Item"){
tree.appendChild(buildExplorerNode(n));
}
});

}

function buildExplorerNode(node){

let div=document.createElement("div");
div.style.marginLeft="12px";

let name=node.querySelector("Properties > string[name='Name']");
let label=name?name.textContent:node.getAttribute("class");

let btn=document.createElement("button");
btn.style.width="100%";
btn.textContent=label;
btn.onclick=()=>showProperties(node);

div.appendChild(btn);

node.childNodes.forEach(c=>{
if(c.nodeName==="Item"){
div.appendChild(buildExplorerNode(c));
}
});

return div;

}

/* PROPERTY VIEW */

function showProperties(node){

let panel=document.getElementById("propertiesData");

let html="<b>"+(
node.querySelector("Properties > string[name='Name']")?.textContent
||node.getAttribute("class")
)+"</b><br>";

node.querySelectorAll("Properties > *").forEach(p=>{
html+=p.getAttribute("name")+": "+p.textContent+"<br>";
});

panel.innerHTML=html;

}

/* UTIL */

function parseVector3(s){
let a=s.split(",");
return{
x:parseFloat(a[0])||1,
y:parseFloat(a[1])||1,
z:parseFloat(a[2])||1
};
}

/* RENDER INSTANCES */

function renderInstance(node,parent){

let cls=node.getAttribute("class");
let obj=null;

if(cls && cls.includes("Part")){

let size=node.querySelector("Properties > Vector3[name='Size']");
let s=size?parseVector3(size.textContent):{x:1,y:1,z:1};

let mat=new THREE.MeshStandardMaterial({
color:Math.random()*0xffffff
});

obj=new THREE.Mesh(
new THREE.BoxGeometry(s.x,s.y,s.z),
mat
);

}

else if(cls && cls.includes("Gui")){

obj=new THREE.Group();

let plane=new THREE.Mesh(
new THREE.PlaneGeometry(5,3),
new THREE.MeshBasicMaterial({
color:0xffffff,
side:THREE.DoubleSide
})
);

obj.add(plane);

}

else if(cls==="Model"||cls==="Folder"){
obj=new THREE.Group();
}

if(obj){

instanceMap.set(node,obj);

(parent?parent:scene).add(obj);

node.childNodes.forEach(c=>{
if(c.nodeName==="Item"){
renderInstance(c,obj);
}
});

}

}

/* BUILD SCENE */

function buildScene(){

scene.clear();

scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));
scene.add(new THREE.GridHelper(2000,200));

xmlDoc.documentElement.childNodes.forEach(n=>{
if(n.nodeName==="Item"){
renderInstance(n,null);
}
});

autoFrameCamera();

}

/* CAMERA FRAME */

function autoFrameCamera(){

let box=new THREE.Box3().setFromObject(scene);
let center=box.getCenter(new THREE.Vector3());
let size=box.getSize(new THREE.Vector3());

let dist=Math.max(size.x,size.y,size.z)*3+300;

camTarget.copy(center);

camera.position.set(
center.x+dist,
center.y+dist,
center.z+dist
);

}

/* ANIMATIONS */

function updateAnimations(){

instanceMap.forEach((obj,node)=>{

let anim=node.querySelector("Properties > string[name='AnimationId']");

if(anim){
obj.rotation.y=Math.sin(animationTime)*1.5;
}

});

}

/* HUD SAFETY CHECK */

function checkHUD(){

document.querySelectorAll(".panel").forEach(p=>{

let style=getComputedStyle(p);
let opacity=parseFloat(style.opacity);
let rect=p.getBoundingClientRect();

let tooBig=
rect.height>window.innerHeight*0.9 ||
rect.width>window.innerWidth*0.9;

if(opacity<0.1 && tooBig){
p.dataset.hiddenHUD="true";
p.style.display="none";
}

if(opacity>=0.1 && p.dataset.hiddenHUD){
p.style.display="block";
p.removeAttribute("data-hiddenHUD");
}

});

}

/* RESIZE */

window.addEventListener("resize",()=>{
camera.aspect=window.innerWidth/window.innerHeight;
camera.updateProjectionMatrix();
renderer.setSize(window.innerWidth,window.innerHeight);
checkHUD();
});

setInterval(checkHUD,2000);

/* START */

initEngine();

</script>

</body>
</html>
