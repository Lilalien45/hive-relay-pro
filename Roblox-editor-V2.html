<script>

/* ================= CORE STATE ================= */

let scene,camera,renderer,xmlDoc=null;
let camTarget=new THREE.Vector3();
let instanceMap=new Map();
let remoteCameras=[];
let time=0;

/* ================= INIT ENGINE ================= */

function initEngine(){

scene=new THREE.Scene();

/* FAST LIGHTING */
scene.add(new THREE.AmbientLight(0xffffff,0.9));

camera=new THREE.PerspectiveCamera(
75,
window.innerWidth/window.innerHeight,
0.5,
50000
);

renderer=new THREE.WebGLRenderer({
antialias:false,
powerPreference:"high-performance"
});

renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);

/* FAST GRID */
let grid=new THREE.GridHelper(2000,100);
grid.material.opacity=0.2;
grid.material.transparent=true;
scene.add(grid);

spawnRemoteCameras();
initControls();

animate();

}

/* ================= MULTIPLAYER CAMERA VISUALS ================= */

function spawnRemoteCameras(){

for(let i=0;i<3;i++){

let cam=new THREE.Mesh(
new THREE.ConeGeometry(15,30,8),
new THREE.MeshBasicMaterial({
wireframe:true
})
);

cam.position.set(
Math.random()*300-150,
50,
Math.random()*300-150
);

remoteCameras.push(cam);
scene.add(cam);

}

}

/* ================= CONTROLS ================= */

function initControls(){

let dragging=false;
let lx=0,ly=0;

window.addEventListener("pointerdown",e=>{
dragging=true;
lx=e.clientX;
ly=e.clientY;
});

window.addEventListener("pointerup",()=>dragging=false);

window.addEventListener("pointermove",e=>{
if(!dragging)return;

/* Smooth orbit physics */
camTarget.x+=(e.clientX-lx)*0.05;
camTarget.y-=(e.clientY-ly)*0.05;

lx=e.clientX;
ly=e.clientY;

});

window.addEventListener("wheel",e=>{
camera.position.z+=e.deltaY*0.4;
});

}

/* ================= MAIN LOOP ================= */

function animate(){

requestAnimationFrame(animate);

time+=0.01;

updateAnimations();
updateRemoteCameras();
updateCameraOrbit();

renderer.render(scene,camera);

}

/* ================= ORBIT CAMERA ================= */

function updateCameraOrbit(){

let radius=600;

camera.position.x=camTarget.x+Math.cos(time)*radius;
camera.position.z=camTarget.z+Math.sin(time)*radius;
camera.position.y=camTarget.y+Math.sin(time*0.5)*radius;

camera.lookAt(camTarget);

}

/* ================= MULTIPLAYER VISUAL ================= */

function updateRemoteCameras(){

remoteCameras.forEach((c,i)=>{

c.rotation.y+=0.01;

if(networkMode==="host"){
c.visible=true;
}else if(networkMode==="private"){
c.visible=false;
}else{
c.visible=i<2;
}

});

}

/* ================= FILE LOADER ================= */

placeLoader.addEventListener("change",e=>{

let f=e.target.files[0];
if(!f)return;

let r=new FileReader();

r.onload=()=>{
parseRobloxXML(r.result);
};

r.readAsText(f);

});

/* ================= PARSER ================= */

function parseRobloxXML(text){

xmlDoc=new DOMParser().parseFromString(text,"text/xml");

buildExplorer();
buildScene();

}

/* ================= EXPLORER ================= */

function buildExplorer(){

let tree=document.getElementById("explorerTree");
tree.innerHTML="";

xmlDoc.documentElement.childNodes.forEach(n=>{
if(n.nodeName==="Item"){
tree.appendChild(buildExplorerNode(n));
}
});

}

function buildExplorerNode(node){

let div=document.createElement("div");
div.style.marginLeft="10px";

let name=node.querySelector("Properties > string[name='Name']");
let label=name?name.textContent:node.getAttribute("class");

let btn=document.createElement("button");
btn.style.width="100%";
btn.textContent=label;
btn.onclick=()=>showProperties(node);

div.appendChild(btn);

node.childNodes.forEach(c=>{
if(c.nodeName==="Item"){
div.appendChild(buildExplorerNode(c));
}
});

return div;

}

/* ================= PROPERTIES ================= */

function showProperties(node){

let panel=document.getElementById("propertiesData");

let html="<b>"+(
node.querySelector("Properties > string[name='Name']")?.textContent
||node.getAttribute("class")
)+"</b><br>";

node.querySelectorAll("Properties > *").forEach(p=>{
html+=p.getAttribute("name")+": "+p.textContent+"<br>";
});

panel.innerHTML=html;

}

/* ================= RENDER INSTANCES ================= */

function parseVector3(s){
let a=s.split(",");
return{
x:parseFloat(a[0])||1,
y:parseFloat(a[1])||1,
z:parseFloat(a[2])||1
};
}

function renderInstance(node,parent){

let cls=node.getAttribute("class");
let obj=null;

/* PARTS */

if(cls.includes("Part")){

let size=node.querySelector("Properties > Vector3[name='Size']");
let s=size?parseVector3(size.textContent):{x:1,y:1,z:1};

let mat=new THREE.MeshBasicMaterial({
color:Math.random()*0xffffff
});

obj=new THREE.Mesh(
new THREE.BoxGeometry(s.x,s.y,s.z),
mat
);

}

/* GUI */

else if(cls.includes("Gui")){

obj=new THREE.Group();

let plane=new THREE.Mesh(
new THREE.PlaneGeometry(5,3),
new THREE.MeshBasicMaterial({
color:0xffffff,
side:THREE.DoubleSide
})
);

obj.add(plane);

}

/* CONTAINERS */

else if(cls==="Model"||cls==="Folder"){
obj=new THREE.Group();
}

if(obj){

instanceMap.set(node,obj);

(parent?parent:scene).add(obj);

node.childNodes.forEach(c=>{
if(c.nodeName==="Item"){
renderInstance(c,obj);
}
});

}

}

/* ================= SCENE BUILD ================= */

function buildScene(){

scene.clear();

scene.add(new THREE.AmbientLight(0xffffff,0.9));

let grid=new THREE.GridHelper(2000,100);
grid.material.opacity=0.2;
grid.material.transparent=true;

scene.add(grid);

xmlDoc.documentElement.childNodes.forEach(n=>{
if(n.nodeName==="Item"){
renderInstance(n,null);
}
});

autoFrameCamera();

}

/* ================= CAMERA FRAME ================= */

function autoFrameCamera(){

let box=new THREE.Box3().setFromObject(scene);
let center=box.getCenter(new THREE.Vector3());
let size=box.getSize(new THREE.Vector3());

camTarget.copy(center);

camera.position.set(
center.x+size.x*2+200,
center.y+size.y*2+200,
center.z+size.z*2+200
);

}

/* ================= ANIMATIONS ================= */

function updateAnimations(){

instanceMap.forEach((obj,node)=>{

let anim=node.querySelector("Properties > string[name='AnimationId']");

if(anim){
obj.rotation.y=Math.sin(time);
}

});

}

/* START */

initEngine();

</script>
